<!DOCTYPE html>
<html>
  <head>
    <title>Table</title>
    <meta charset="utf-8">
    <!--link rel="stylesheet" type="text/css" href="03.00.table.css"-->
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <div id="app">
      <!-- my app renders here -->
    </div>
    <script src="build/react.js"></script>
    <script src="build/react-dom.js"></script>
    <script src="babel/browser.js"></script>
    <script type="text/babel">
      const Excel = React.createClass({
        getInitialState: function() {
          const stateData = [
            {id: "S001", sagyoNaiyo: "チケットを予約する", selected: false},
            {id: "S002", sagyoNaiyo: "掃除をする", selected: false},
            {id: "S003", sagyoNaiyo: "アプリを開発する", selected: false}
          ];
          return {
            data: stateData,
            alternative: stateData,
            todoCount: stateData.length,
            radio: "all"
          };
        },
        componentDidMount: function() {
          window.setInterval(() => {
            let allWorks = this.state.data;
            const uncheckedWorks = allWorks.filter(d => !d.selected);  
            notifyMe(uncheckedWorks);
          }, 10000);
        },
        // displayName: 'Excel',
        render: function() {
          var checks = this.state.alternative.map(function(d) {
          return (
            <section>
              <input type="checkbox" id={d.id} checked={d.selected} onChange={this.__changeSelection.bind(this, d.id)} />
              <label className="checklabel" htmlFor={d.id}>{d.sagyoNaiyo}</label>
              <button className="destroy" onClick={() => {this.__destroyRow(d.id)}}>×</button>
              <br />
            </section>
            );
          }.bind(this));
          return (
            <div>
              <section>
                <h3>todos</h3>
                <section className="boxshadow">
                  <input type="text" onKeyPress={this.__pressEnter} />
                  <section>
                    {checks}
                    <br />
                    {this.state.todoCount}
                    {" items Left  "}
                    <input type="radio" id="radioAll" checked={this.state.radio==="all"} onChange={() => {this.__selectCheckedRow("all")}} />
                    <label className="radiolabel" htmlFor="radioAll">All</label>
                    <input type="radio" id="radioActive" checked={this.state.radio==="active"} onChange={() => {this.__selectCheckedRow("active")}} />
                    <label className="radiolabel" htmlFor="radioActive">Active</label>
                    <input type="radio" id="radioCompleted" checked={this.state.radio==="completed"} onChange={() => {this.__selectCheckedRow("completed")}} />
                    <label className="radiolabel" htmlFor="radioCompleted">Completed</label>
                  </section>
                </section>
              </section>
            </div>
          );
        },

        __changeSelection: function(id) {
          let todoCount = 0;
          let nextState = this.state.data.map(function(d) {
            if (d.id === id) {
              if(d.selected) {
                todoCount++;
              }
            }
            else if (d.selected === false) {
              todoCount++;
            }
            return {
              id: d.id,
              sagyoNaiyo: d.sagyoNaiyo,
              selected: (d.id === id ? !d.selected: d.selected)
            };
          });
          this.setState({data: nextState, alternative: nextState, todoCount: todoCount});
        },

        __pressEnter: function(e) {
          if (e.charCode === 13) {
            let nextState = this.state.data;
            const lastID = (nextState[(nextState.length) - 1]).id;
            const nextNumber = Number(lastID.slice(1)) + 1;
            let nextID = "S";
            if (nextNumber < 10) {
              nextID = nextID + "00" + nextNumber;
            }
            else if (nextNumber < 100) {
              nextID = nextID + "0" + nextNumber;
            }
            const additionalState = {
              id: nextID,
              sagyoNaiyo: e.target.value,
              selected: false 
            };
            nextState.push(additionalState);
            let todoCount = this.state.todoCount;
            todoCount++;
            this.setState({data: nextState, alternative: nextState, todoCount: todoCount});
          }
        },

        __destroyRow: function(id) {
          const needlessId = id;
          let nextState =this.state.data.filter(d => d.id !== needlessId);
          let todoCount = this.state.todoCount;
          todoCount--;
          this.setState({data: nextState, alternative: nextState, todoCount: todoCount});
        },

        __selectCheckedRow: function(status) {
          let currentState = this.state.data;
          let nextState = currentState;
          switch (status) {
            case "all":
              break;
            case "active":
              nextState = currentState.filter(d => !d.selected);
              break;
            case "completed":
              nextState = currentState.filter(d => d.selected);
              break;
            default:
              console.log("default");
          }
          this.setState({alternative: nextState, radio: status});
        }

      });

      const dt = new Date();
      const year = dt.getFullYear() + "";
      const month = dt.getMonth()+1 + "";
      const date = dt.getDate() + "";
      const youbis = ["日","月","火","水","木","金","土"];
      const youbi = youbis[dt.getDay()];
      const yyyymmddyoubi = year + "年" + month + "月" + date + "日" + "(" + youbi + ")";
      
      const headers = [
        yyyymmddyoubi
      ];
      
      const data = [
        ["The Lord of the Rings", "J. R. R. Tolkien", "English", "1954–1955", "150 million"], 
        ["Le Petit Prince (The Little Prince)", "Antoine de Saint-Exupéry", "French", "1943", "140 million"], 
        ["Harry Potter and the Philosopher's Stone", "J. K. Rowling", "English", "1997", "107 million"], 
        ["And Then There Were None", "Agatha Christie", "English", "1939", "100 million"], 
        ["Dream of the Red Chamber", "Cao Xueqin", "Chinese", "1754–1791", "100 million"], 
        ["The Hobbit", "J. R. R. Tolkien", "English", "1937", "100 million"], 
        ["She: A History of Adventure", "H. Rider Haggard", "English", "1887", "100 million"],
      ];
      
      ReactDOM.render(
        React.createElement(Excel, {
          headers: headers,
          initialData: data,
        }),
        document.getElementById("app")
      );

      function notifyMe(data) {
        if (!("Notification" in window)) { // in演算子は指定されたオブジェクトに指定されたプロパティがある場合、trueを返す
        alert("このブラウザは通知をサポートしていません");
        }
        else if (Notification.permission === "granted") { // 既に通知の許可を得ているか確認する
          let notification = new Notification("未完了の作業があります"); // 許可を得ている場合は通知を作成する
        }
        else if (Notification.permission !== "denied") {
          Notification.requestPermission(function (permission) { // ユーザーに通知の許可を求める
            if (permission === "granted") {
              let notification = new Notification("未完了の作業があります"); // ユーザーが許可した場合は通知を作成する
            }
          });
        }
        let works = "";
        for (var i = 0; i < data.length; i++) {
          if (i === 0) {
            works = data[i].sagyoNaiyo;
            continue;
          }
          works = works + "," + data[i].sagyoNaiyo;
        }
        spawnNotification(works, "em.png", "本日の作業");
      }

      function spawnNotification(theBody,theIcon,theTitle) {
        var options = {
          body: theBody,
          icon: theIcon
        }
        var n = new Notification(theTitle,options);
        setTimeout(n.close.bind(n), 5000); 
      }
    </script>
  </body>
</html>

